<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Available Treatments - PhpStorm Dark Theme</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* PhpStorm dark theme inspired colors */
    body {
      margin: 0;
      font-family: 'Fira Code', 'Consolas', 'Monaco', monospace, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #282c34;
      color: #abb2bf;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    h1 {
      font-size: 2.8rem;
      color: #61dafb;
      margin-bottom: 20px;
      font-weight: 700;
      text-shadow: 0 0 5px #61dafb88;
    }

    #searchBar {
      width: 100%;
      max-width: 480px;
      padding: 12px 16px;
      margin-bottom: 30px;
      border: none;
      border-radius: 6px;
      background-color: #21252b;
      color: #abb2bf;
      font-size: 16px;
      box-shadow: inset 0 0 5px #3e4451;
      transition: box-shadow 0.3s ease;
    }
    #searchBar::placeholder {
      color: #5c6370;
      font-style: italic;
    }
    #searchBar:focus {
      outline: none;
      box-shadow: 0 0 8px #61dafb;
      background-color: #1c1f26;
      color: #e6e6e6;
    }

    #downloadPrescriptionBtn {
      background: linear-gradient(135deg, #61dafb, #5288b6);
      border: none;
      border-radius: 8px;
      color: #282c34;
      font-weight: 700;
      font-size: 18px;
      padding: 14px 24px;
      cursor: pointer;
      margin-bottom: 40px;
      transition: background-color 0.3s ease, transform 0.2s ease;
      box-shadow: 0 3px 10px #3f8cff88;
    }
    #downloadPrescriptionBtn:hover {
      background: #5288b6;
      color: white;
      transform: translateY(-3px);
    }

    /* Container grid for cards */
    #cardsContainer {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
      width: 100%;
      max-width: 1100px;
    }

    /* Individual card */
    .card {
      background-color: #21252b;
      border-radius: 12px;
      padding: 20px 24px;
      box-shadow: 0 4px 10px #000000aa;
      display: flex;
      flex-direction: column;
      color: #abb2bf;
      transition: box-shadow 0.3s ease, transform 0.2s ease;
      position: relative;
    }
    .card:hover {
      box-shadow: 0 6px 18px #61dafbaa;
      transform: translateY(-6px);
    }

    .card h3 {
      color: #61dafb;
      font-weight: 700;
      font-size: 1.6rem;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card p.details {
      font-size: 1rem;
      color: #abb2bfcc;
      margin-bottom: 15px;
      line-height: 1.4;
      flex-grow: 1;
      overflow-wrap: break-word;
    }

    .media {
      display: flex;
      gap: 12px;
      margin-bottom: 15px;
    }

    .media img,
    .media video {
      max-width: 150px;
      border-radius: 10px;
      background: #181a20;
      box-shadow: 0 0 8px #3e4451;
      cursor: pointer;
      object-fit: cover;
      height: 100px;
      flex-shrink: 0;
      transition: transform 0.3s ease;
    }
    .media img:hover,
    .media video:hover {
      transform: scale(1.05);
    }
    .media video {
      height: 100px;
    }

    .related-meds {
      font-size: 0.95rem;
      color: #98c379;
      margin-bottom: 15px;
      font-weight: 600;
      white-space: pre-wrap;
    }

    .rating {
      font-size: 1rem;
      margin-bottom: 10px;
      color: #e5c07b;
      font-weight: 600;
    }

    .reviews {
      font-size: 0.9rem;
      max-height: 80px;
      overflow-y: auto;
      padding-right: 5px;
      margin-bottom: 12px;
      color: #abb2bfaa;
      border-top: 1px solid #3e4451;
    }

    /* Scrollbar for reviews */
    .reviews::-webkit-scrollbar {
      width: 6px;
    }
    .reviews::-webkit-scrollbar-thumb {
      background-color: #61dafb77;
      border-radius: 3px;
    }

    /* Action buttons container */
    .actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: auto;
    }

    .btn {
      flex: 1;
      padding: 10px 0;
      border-radius: 8px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border: none;
      color: #282c34;
      user-select: none;
    }
    .btn.prescription {
      background: #98c379;
    }
    .btn.prescription:hover {
      background: #7cb76b;
      color: white;
      transform: translateY(-2px);
    }
    .btn.review {
      background: #61dafb;
    }
    .btn.review:hover {
      background: #3db7f9;
      color: white;
      transform: translateY(-2px);
    }

    /* Review modal */
    #reviewModal {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background-color: rgba(40,44,52,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #reviewModal.active {
      display: flex;
    }
    #reviewModal .modal-content {
      background-color: #21252b;
      border-radius: 12px;
      padding: 24px;
      width: 320px;
      box-shadow: 0 8px 16px #61dafbaa;
      color: #abb2bf;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    #reviewModal h3 {
      color: #61dafb;
      margin: 0 0 10px;
      text-align: center;
      font-weight: 700;
    }
    #reviewModal label {
      font-size: 0.9rem;
      color: #abb2bfcc;
      font-weight: 600;
    }
    #reviewModal input[type="number"],
    #reviewModal textarea {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: none;
      background-color: #1c1f26;
      color: #abb2bf;
      resize: vertical;
      font-family: monospace;
      font-size: 14px;
      box-shadow: inset 0 0 5px #3e4451;
    }
    #reviewModal textarea {
      min-height: 80px;
    }
    #reviewModal input[type="number"]::-webkit-inner-spin-button,
    #reviewModal input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    #reviewModal .btn-submit {
      background: #61dafb;
      color: #282c34;
      font-weight: 700;
      border-radius: 8px;
      padding: 12px 0;
      cursor: pointer;
      font-size: 16px;
      border: none;
      transition: background-color 0.3s ease;
    }
    #reviewModal .btn-submit:hover {
      background: #3db7f9;
      color: white;
    }
    #reviewModal .btn-close {
      background: #e06c75;
      color: white;
      font-weight: 700;
      border-radius: 8px;
      padding: 10px 0;
      cursor: pointer;
      font-size: 14px;
      border: none;
      margin-top: 10px;
      transition: background-color 0.3s ease;
    }
    #reviewModal .btn-close:hover {
      background: #c94f57;
    }

    /* Image Zoom Modal */
    #imageZoomModal {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background-color: rgba(40,44,52,0.95);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      cursor: zoom-out;
      transition: opacity 0.3s ease;
    }
    #imageZoomModal.show {
      display: flex;
      opacity: 1;
    }
    #imageZoomModal img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 12px;
      box-shadow: 0 0 30px #61dafbcc;
      user-select: none;
      transition: transform 0.3s ease;
    }

    /* Pagination Controls */
    #paginationControls {
      margin: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .btn {
      padding: 10px 15px;
      cursor: pointer;
      background-color: #61dafb;
      color: #282c34;
      border-radius: 8px;
      font-weight: 700;
      font-size: 16px;
      transition: background-color 0.3s ease;
      margin: 0 10px;
    }

    .btn:hover {
      background-color: #5288b6;
      color: white;
    }

    #prevPageBtn:disabled, #nextPageBtn:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }

  </style>
</head>
<body>

  <h1>Available Treatments</h1>

  <input
    type="text"
    id="searchBar"
    placeholder="Search by name, details, or related medicines…"
    aria-label="Search treatments"
  />

  <div id="cardsContainer" role="list" aria-live="polite"></div>

  <button id="downloadPrescriptionBtn" aria-label="Download Prescription as PDF">Download Prescription as PDF</button>

  <!-- Pagination Controls -->
  <div id="paginationControls">
    <button id="prevPageBtn" class="btn">Previous</button>
    <button id="nextPageBtn" class="btn">Next</button>
  </div>

  <!-- Review Modal -->
  <div id="reviewModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" tabindex="-1">
    <div class="modal-content">
      <h3 id="modalTitle">Submit Review</h3>
      <label for="ratingInput">Rating (1-5):</label>
      <input type="number" id="ratingInput" min="1" max="5" aria-required="true" />
      <label for="reviewInput">Review:</label>
      <textarea id="reviewInput" rows="4" aria-required="true"></textarea>
      <button class="btn-submit" id="submitReviewBtn">Submit Review</button>
      <button class="btn-close" id="closeReviewModalBtn">Cancel</button>
    </div>
  </div>

  <!-- Image Zoom Modal -->
  <div id="imageZoomModal" role="dialog" aria-modal="true" aria-label="Zoomed treatment image">
    <img id="zoomedImage" src="" alt="Zoomed Treatment Image" />
  </div>

  <script>
    const apiBase = 'http://localhost:3000';
    let allTreatments = [];
    let prescriptionItems = [];
    let selectedTreatmentId = null;
    let currentPage = 1;
    const treatmentsPerPage = 12;

    function escapeHTML(str) {
      if (!str) return '';
      return str.replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#39;");
    }

    // Load treatments and render cards
    function loadTreatments() {
      fetch(`${apiBase}/get-treatments`)
        .then(res => res.json())
        .then(data => {
          allTreatments = data;
          renderCards(getPaginatedTreatments());
          updatePaginationControls();
        })
        .catch(err => console.error("Load error:", err));
    }

    // Render cards for the current page
    function renderCards(items) {
      const container = document.getElementById('cardsContainer');
      container.innerHTML = '';
      if (!items.length) {
        container.innerHTML = `<p style="color:#5c6370; text-align:center;">No treatments found.</p>`;
        return;
      }

      items.forEach(treatment => {
        fetch(`${apiBase}/get-treatment-rating/${treatment.id}`)
          .then(res => res.json())
          .then(data => {
            const avgRating = data.average_rating || 'N/A';
            const reviewsArr = data.reviews || [];
            const reviewsHTML = reviewsArr.length
              ? reviewsArr.map(r => `<div>• ${escapeHTML(r)}</div>`).join('')
              : '<i>No reviews yet</i>';

            const card = document.createElement('article');
            card.className = 'card';
            card.setAttribute('role', 'listitem');
            card.tabIndex = 0;

            const imgTag = treatment.image
              ? `<img src="${escapeHTML(treatment.image)}" alt="Image of ${escapeHTML(treatment.name)}" loading="lazy" class="zoomable-image" />`
              : `<div style="color:#5c6370; font-style:italic; font-size:0.85rem; width:150px; height:100px; display:flex; align-items:center; justify-content:center; background:#2c313c; border-radius:10px;">No Image</div>`;

            const videoTag = treatment.video
              ? `<video controls muted preload="metadata" aria-label="Video of ${escapeHTML(treatment.name)}"><source src="${escapeHTML(treatment.video)}" type="video/mp4">Your browser does not support the video tag.</video>`
              : `<div style="color:#5c6370; font-style:italic; font-size:0.85rem; width:150px; height:100px; display:flex; align-items:center; justify-content:center; background:#2c313c; border-radius:10px;">No Video</div>`;

            card.innerHTML = `
              <h3><i class="fas fa-notes-medical"></i> ${escapeHTML(treatment.name)}</h3>
              <p class="details">${escapeHTML(treatment.details)}</p>
              <div class="media" aria-label="Media for ${escapeHTML(treatment.name)}">
                ${imgTag}
                ${videoTag}
              </div>
              <div class="related-meds"><strong>Related Medicines:</strong><br/>${escapeHTML(treatment.related_medicine || 'None')}</div>
              <div class="rating">Average Rating: ${avgRating}</div>
              <div class="reviews" aria-label="Reviews for ${escapeHTML(treatment.name)}">${reviewsHTML}</div>
              <div class="actions">
                <button class="btn prescription" aria-label="Add ${escapeHTML(treatment.name)} to prescription" onclick="addToPrescription('${escapeHTML(treatment.name)}', '${escapeHTML(treatment.details)}')">
                  <i class="fas fa-prescription-bottle-alt"></i> Add to Prescription
                </button>
                <button class="btn review" aria-label="Add review for ${escapeHTML(treatment.name)}" onclick="openReviewModal(${treatment.id})">
                  <i class="fas fa-star"></i> Ratings & Review
                </button>
              </div>
            `;

            container.appendChild(card);
          })
          .catch(err => console.error(`Error loading rating/reviews for treatment ${treatment.id}:`, err));
      });

      // Attach zoom event listeners after rendering
      setTimeout(() => {
        document.querySelectorAll('.zoomable-image').forEach(img => {
          img.addEventListener('click', () => openImageZoom(img.src, img.alt));
        });
      }, 500);
    }

    // Search filter
    document.getElementById('searchBar').addEventListener('input', e => {
      const term = e.target.value.toLowerCase().trim();
      const filtered = allTreatments.filter(t =>
        t.name.toLowerCase().includes(term) ||
        t.details.toLowerCase().includes(term) ||
        (t.related_medicine || '').toLowerCase().includes(term)
      );
      renderCards(filtered);
    });

    // Paginate the treatments
    function getPaginatedTreatments() {
      const start = (currentPage - 1) * treatmentsPerPage;
      const end = start + treatmentsPerPage;
      return allTreatments.slice(start, end);
    }

    // Update pagination controls
    function updatePaginationControls() {
      const totalPages = Math.ceil(allTreatments.length / treatmentsPerPage);
      const prevPageBtn = document.getElementById('prevPageBtn');
      const nextPageBtn = document.getElementById('nextPageBtn');

      prevPageBtn.disabled = currentPage === 1;
      nextPageBtn.disabled = currentPage === totalPages;

      prevPageBtn.onclick = () => {
        if (currentPage > 1) {
          currentPage--;
          renderCards(getPaginatedTreatments());
        }
      };

      nextPageBtn.onclick = () => {
        if (currentPage < totalPages) {
          currentPage++;
          renderCards(getPaginatedTreatments());
        }
      };
    }

    // Add to prescription list
    function addToPrescription(name, details) {
      prescriptionItems.push({ name, details });
      alert(`"${name}" added to prescription!`);
    }

    // Download prescription PDF
    document.getElementById('downloadPrescriptionBtn').addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(18);
      doc.setTextColor('#61dafb');
      doc.text('Doctor Prescription', 20, 20);
      doc.setFontSize(12);
      doc.setTextColor('#abb2bf');
      doc.text('XYZ Health Center', 20, 30);
      doc.text('Dr. John Doe, MD', 20, 35);
      doc.text('Address: 123 Medical St, City, Zip Code', 20, 40);
      doc.text('Phone: (123) 456-7890', 20, 45);
      doc.text('Date: ' + new Date().toLocaleDateString(), 150, 45);

      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      doc.text('Prescription Details:', 20, 55);

      doc.setFontSize(12);
      let y = 65;
      if (prescriptionItems.length === 0) {
        doc.text('No medicines added to prescription', 20, y);
      } else {
        prescriptionItems.forEach(item => {
          doc.setFont('helvetica', 'normal');
          doc.text(`Medicine: ${item.name}`, 20, y);
          y += 8;
          doc.text(`Details: ${item.details}`, 20, y);
          y += 14;
          if (y > 270) {
            doc.addPage();
            y = 20;
          }
        });
      }

      doc.setFontSize(10);
      doc.setFont('helvetica', 'italic');
      doc.text('Note: This prescription is valid only after review by a licensed doctor.', 20, y + 10);

      doc.save('professional_prescription.pdf');
    });

    // Review modal handlers
    const reviewModal = document.getElementById('reviewModal');
    const ratingInput = document.getElementById('ratingInput');
    const reviewInput = document.getElementById('reviewInput');
    const submitReviewBtn = document.getElementById('submitReviewBtn');
    const closeReviewModalBtn = document.getElementById('closeReviewModalBtn');

    function openReviewModal(treatmentId) {
      selectedTreatmentId = treatmentId;
      ratingInput.value = '';
      reviewInput.value = '';
      reviewModal.classList.add('active');
      ratingInput.focus();
    }

    function closeReviewModal() {
      reviewModal.classList.remove('active');
      selectedTreatmentId = null;
    }

    closeReviewModalBtn.addEventListener('click', closeReviewModal);

    // Submit review
    submitReviewBtn.addEventListener('click', () => {
      const rating = ratingInput.value;
      const review = reviewInput.value.trim();
      const userId = 1; // Mock logged-in user id

      if (!rating || rating < 1 || rating > 5) {
        alert('Please enter a rating between 1 and 5.');
        ratingInput.focus();
        return;
      }
      if (!review) {
        alert('Please enter a review.');
        reviewInput.focus();
        return;
      }
      if (!selectedTreatmentId) {
        alert('No treatment selected for review.');
        return;
      }

      fetch(`${apiBase}/submit-review`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          treatment_id: selectedTreatmentId,
          user_id: userId,
          rating,
          review
        })
      })
      .then(res => res.json())
      .then(data => {
        alert('Review submitted successfully!');
        closeReviewModal();
        loadTreatments(); // Reload treatments & reviews
      })
      .catch(err => {
        console.error('Error submitting review:', err);
        alert('Failed to submit review. Please try again later.');
      });
    });

    // Image Zoom Modal logic
    const imageZoomModal = document.getElementById('imageZoomModal');
    const zoomedImage = document.getElementById('zoomedImage');

    function openImageZoom(src, alt = 'Zoomed image') {
      zoomedImage.src = src;
      zoomedImage.alt = alt;
      imageZoomModal.classList.add('show');
      document.body.style.overflow = 'hidden'; // Prevent background scroll
    }

    // Close zoom modal on click outside image or on image
    imageZoomModal.addEventListener('click', (e) => {
      if (e.target === imageZoomModal || e.target === zoomedImage) {
        closeImageZoom();
      }
    });

    // Close zoom modal on Escape key
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && imageZoomModal.classList.contains('show')) {
        closeImageZoom();
      }
    });

    function closeImageZoom() {
      imageZoomModal.classList.remove('show');
      zoomedImage.src = '';
      document.body.style.overflow = '';
    }

    window.addEventListener('DOMContentLoaded', loadTreatments);
  </script>

  <!-- Font Awesome for icons -->
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

</body>
</html>
